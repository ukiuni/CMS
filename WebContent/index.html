<!DOCTYPE html>
<html ng-app="myApp">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="api/app/rootURL.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.min.js"></script>
<script src="https://rawgithub.com/angular-ui/ui-sortable/master/src/sortable.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular-cookies.js"></script>

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.10.0/ui-bootstrap-tpls.min.js"></script>
<script src="http://code.angularjs.org/1.2.19/angular-route.min.js"></script>
<script src="http://m-e-conroy.github.io/angular-dialog-service/javascripts/dialogs.min.js" type="text/javascript"></script>
<script type="text/javascript" src="scripts/marked.min.js"></script>
<script type="text/javascript" src="scripts/angular-marked.min.js"></script>
<script type="text/javascript" src="scripts/angular-file-upload-shim.min.js"></script>
<script type="text/javascript" src="scripts/angular-file-upload.min.js"></script>
<link rel="stylesheet" href="//yandex.st/highlightjs/8.0/styles/github.min.css">
<script src="//yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="scripts/application.css">
</head>
<body>
	<div id="header" ng-include="'template/header.html'"></div>
	<div id="content" ng-view></div>
	<script type="text/javascript">
		var myApp = angular.module('myApp', [ 'ui.sortable', 'ui.bootstrap', 'hc.marked', 'ngRoute', 'ngCookies', 'angularFileUpload' ]);
		myApp.config([ 'markedProvider', '$routeProvider', '$locationProvider', function(markedProvider, $routeProvider, $locationProvider) {
			markedProvider.setOptions({
				gfm : true,
				tables : true,
				breaks : true,
				highlight : function(code) {
					return hljs.highlightAuto(code).value;
				}
			});
			$routeProvider.when('/', {
				templateUrl : 'template/top.html',
				controller : 'topController'
			}).when('/myPage', {
				templateUrl : 'template/myPage.html?' + new Date().getTime(),
				controller : 'myPageController'
			}).when('/editReport', {
				templateUrl : 'template/editReport.html?' + new Date().getTime(),
				controller : 'editReportController'
			}).when('/report', {
				templateUrl : 'template/report.html?' + new Date().getTime(),
				controller : 'reportController'
			}).when('/editProfile', {
				templateUrl : 'template/editProfile.html?' + new Date().getTime(),
				controller : 'editProfileController'
			}).otherwise({
				redirectTo : '/'
			});
			$locationProvider.html5Mode(true);
		} ]);
		myApp.run([ "$rootScope", "$http", "$cookies", "$location", function($rootScope, $http, $cookies, $location) {
			var accountAccessKey = $cookies.accountAccessKey;
			$rootScope.logout = function() {
				$rootScope.loginAccount = null;
				var past = new Date();
				past.setTime(0);
				document.cookie = "accountAccessKey=;expires=" + past.toGMTString();
				for ( var i in $location.search()) {
					$location.search(i, null)
				}
				$location.path('/');
			}
			if (accountAccessKey) {
				$http.get("api/account/loadByAccessKey", {
					params : {
						accessKey : accountAccessKey
					}
				}).success(function(account) {
					$rootScope.loginAccount = account;
				}).error(function(e) {
					$rootScope.logout();
				});
			}
		} ]);
		myApp.controller("topController", [ "$rootScope", "$scope", "$http", "$location", "$cookies", function($rootScope, $scope, $http, $location, $cookies) {
			if ($rootScope.loginAccount) {
				$location.path('/myPage');
				return;
			}
			$scope.createAccount = function() {
				$http.post("api/account", $scope.newAccount).success(function(data) {
					$rootScope.loginAccount = data;
					$location.path('/myPage');
				}).error(function(e) {
					console.log("error" + e);
				});
			}
			$scope.login = function() {
				$http.post("api/account/login", $scope.loginAccount).success(function(data) {
					$rootScope.loginAccount = data;
					var cookieExpires = new Date();
					cookieExpires.setTime(cookieExpires.getTime() + 30 * 24 * 60 * 60 * 1000);
					document.cookie = "accountAccessKey=" + $rootScope.loginAccount.accessKey + ";expires=" + cookieExpires.toGMTString() + ";";
					$location.path('/myPage');
				}).error(function(e) {
					console.log("error" + e);
				});
			}
			$scope.action = "save";
		} ]);
		myApp.controller("myPageController", [ "$rootScope", "$scope", "$http", "$location", function($rootScope, $scope, $http, $location) {
			if (!$rootScope.loginAccount) {
				$location.path('/');
				return;
			}
			$http.get("api/report/loadByAccessKey", {
				params : {
					accessKey : $rootScope.loginAccount.accessKey
				}
			}).success(function(data) {
				$scope.reports = data;
			}).error(function(e) {
				console.log("error" + e);
			});
			$scope.createReport = function() {
				for ( var i in $location.search()) {
					$location.search(i, null)
				}
				$location.path('/editReport');
			}
			$scope.editProfile = function() {
				$location.path('/editProfile');
			}
			$scope.showReport = function(reportKey) {
				console.log("showReport = " + reportKey);
				$location.search('key', reportKey).path('/editReport');
			}
			$scope.showPublishedReport = function(report, $event) {
				$location.search("key", report.key).path("/report");
				if ($event) {
					$event.stopPropagation();
				}
			}
		} ]);
		myApp.controller("reportController", [ "$rootScope", "$scope", "$http", "$location", function($rootScope, $scope, $http, $location) {
			console.log("report Show = " + $location.search()["key"]);
			if (!$location.search()["key"]) {
				return;
			}
			$http.get("api/report/load/" + $location.search()["key"]).success(function(report) {
				console.log("success");
				$scope.report = report;
			}).error(function(e) {
				console.log(e);
			});
		} ]);
		myApp.controller("editReportController", [ "$rootScope", "$scope", "$http", "$location", "$modal", function($rootScope, $scope, $http, $location, $modal) {
			if (!$rootScope.loginAccount) {
				$location.path('/');
				return;
			}
			var loadSuccess = function(data) {
				$scope.report = data;
				console.log("asdfasdfasdfad = " + $scope.report.status);
				if ("published" == $scope.report.status) {
					$scope.action = "publish";
				} else if ("draft" == $scope.report.status) {
					$scope.action = "save as draft";
				} else if ("private" == $scope.report.status) {
					$scope.action = "save as private";
				}
			};
			var loadFail = function(e) {
				console.log("error" + e);
				$location.path('/');
			};
			if ($location.search()["key"]) {
				$http.get("api/report/load/" + $location.search()["key"], {
					params : {
						accessKey : $scope.loginAccount.accessKey,
					}
				}).success(loadSuccess).error(loadFail);
			} else {
				$http.get("api/report/create", {
					params : {
						accessKey : $scope.loginAccount.accessKey
					}
				}).success(loadSuccess).error(loadFail);
			}
			$scope.doAction = function() {
				console.log('doAction = ' + $scope.action);
				if ("delete" != $scope.action) {
					$scope.report.accountAccessKey = $rootScope.loginAccount.accessKey;
					$http.put("api/report", $scope.report).success(function(data) {
						$location.search("lastAction", "{\"action\":\"saved\",\"key\":\"" + $scope.report.key + "\"}").path('/myPage');
					}).error(function(e) {
						console.log("error" + e);
					});
				} else {
					var ModalInstanceCtrl = [ "$scope", "$modalInstance", "title", "body", "report", function($scope, $modalInstance, title, body, report) {
						$scope.title = title;
						$scope.body = body;
						$scope.deleteReport = function() {
							$modalInstance.close(report.key);
						};
					} ];
					var modalInstance = $modal.open({
						templateUrl : 'template/confirmDialog.html?' + new Date().getTime(),
						controller : ModalInstanceCtrl,
						resolve : {
							title : function() {
								return "Delete Report?";
							},
							body : function() {
								return "You realy want to delete this report?";
							},
							report : function() {
								return $scope.report;
							}
						}
					});
					modalInstance.result.then(function(deleteReportKey) {
						$scope.deleteReport(deleteReportKey);
					}, function() {
						console.log('Modal dismissed at: ' + new Date());
					});
				}
			};
			$scope.changeAction = function(action) {
				if ("publish" == action) {
					$scope.report.status = "published";
				} else if ("save as draft" == action) {
					$scope.report.status = "draft";
				} else if ("save as private" == action) {
					$scope.report.status = "private";
				}
				$scope.action = action;
			};
			$scope.cancel = function() {
				for ( var i in $location.search()) {
					$location.search(i, null)
				}
				$location.path('/myPage');
			};
			$scope.deleteReport = function(reportKey) {
				$http.put("api/report/delete", {
					key : reportKey,
					accountAccessKey : $rootScope.loginAccount.accessKey
				}).success(function() {
					$location.search("lastAction", "{\"action\":\"deleted\",\"key\":\"" + $scope.report.key + "\"}").path('/myPage');
				}).error(function() {
					console.log("e");
				});
			};
		} ]);
		myApp.controller("editProfileController", [ "$rootScope", "$scope", "$http", "$location", "$upload", function($rootScope, $scope, $http, $location, $upload) {
			if (!$rootScope.loginAccount) {
				$location.path('/');
				return;
			}
			$scope.editingAccount = $.extend(true, {}, $rootScope.loginAccount);
			$scope.onIconImageSelect = function($file) {
				(function() {
					var value = $upload.upload({
						url : "api/account/registImage",
						method : "POST",
						data : {
							accountAccessKey : $rootScope.loginAccount.accessKey
						},
						file : $file
					}).progress(function(evt) {
						console.log('percent: ' + parseInt(100.0 * evt.loaded / evt.total));
					}).success(function(imageKey, status, headers, config) {
						$scope.editingAccount.iconUrl = "api/account/icon/" + imageKey;
					}).error(function(data, status, headers, config) {
						console.log("uploadFailed = " + data);
					});
					console.log("uploaded = " + value);
				})();
			}
			$scope.cancel = function(action) {
				$location.path('/myPage');
			}
			$scope.save = function(action) {
				var accountAccessKey = $rootScope.loginAccount.accessKey;
				$scope.editingAccount.accessKey = accountAccessKey;
				$http.put("api/account/update", $scope.editingAccount).success(function(account) {
					$.extend(true, $rootScope.loginAccount, account);
					$rootScope.loginAccount.accessKey = accountAccessKey;
					$location.path('/myPage');
				}).error(function(e) {
					console.log(e)
				});
			}
		} ]);
	</script>
	<div id="header" ng-include="'template/footer.html'"></div>
</body>
</html>