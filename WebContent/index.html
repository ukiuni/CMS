<!DOCTYPE html>
<html ng-app="myApp">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="api/app/rootURL.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.min.js"></script>
<script src="https://rawgithub.com/angular-ui/ui-sortable/master/src/sortable.js"></script>

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.10.0/ui-bootstrap-tpls.min.js"></script>
<script src="http://code.angularjs.org/1.2.19/angular-route.min.js"></script>
<script src="http://m-e-conroy.github.io/angular-dialog-service/javascripts/dialogs.min.js" type="text/javascript"></script>
<script type="text/javascript" src="scripts/marked.min.js"></script>
<script type="text/javascript" src="scripts/angular-marked.min.js"></script>
<link rel="stylesheet" href="//yandex.st/highlightjs/8.0/styles/github.min.css">
<script src="//yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="scripts/application.css">
</head>
<body>
	<div id="header" ng-include="'template/header.html'"></div>
	<div id="content" ng-view></div>
	<script type="text/javascript">
		var myApp = angular.module('myApp', [ 'ui.sortable', 'ui.bootstrap', 'hc.marked', 'ngRoute' ]);
		myApp.config([ 'markedProvider', '$routeProvider', '$locationProvider', function(markedProvider, $routeProvider, $locationProvider) {
			markedProvider.setOptions({
				gfm : true,
				tables : true,
				breaks : true,
				highlight : function(code) {
					return hljs.highlightAuto(code).value;
				}
			});
			$routeProvider.when('/', {
				templateUrl : 'template/top.html',
				controller : 'topController'
			}).when('/myPage', {
				templateUrl : 'template/myPage.html?' + new Date().getTime(),
				controller : 'myPageController'
			}).when('/editReport', {
				templateUrl : 'template/editReport.html?' + new Date().getTime(),
				controller : 'editReportController'
			}).otherwise({
				redirectTo : '/'
			});
			$locationProvider.html5Mode(true);
		} ]);
		myApp.controller("topController", [ "$rootScope", "$scope", "$http", "$location", function($rootScope, $scope, $http, $location) {
			if ($rootScope.loginAccount) {
				$location.path('/myPage');
				return;
			}
			$scope.createAccount = function() {
				$http.post("api/account", $scope.newAccount).success(function(data) {
					$rootScope.loginAccount = data;
					$location.path('/myPage');
				}).error(function(e) {
					console.log("error" + e);
				});
			}
			$scope.login = function() {
				$http.post("api/account/login", $scope.loginAccount).success(function(data) {
					$rootScope.loginAccount = data;
					$location.path('/myPage');
				}).error(function(e) {
					console.log("error" + e);
				});
			}
			$scope.action = "save";
		} ]);
		myApp.controller("myPageController", [ "$rootScope", "$scope", "$http", "$location", function($rootScope, $scope, $http, $location) {
			if (!$rootScope.loginAccount) {
				$location.path('/');
				return;
			}
			$http.get("api/report/loadByAccessKey", {
				params : {
					accessKey : $scope.loginAccount.accessKey
				}
			}).success(function(data) {
				$scope.reports = data;
			}).error(function(e) {
				console.log("error" + e);
			});
			$scope.createReport = function() {
				$location.path('/editReport');
			}
			$scope.showReport = function(reportKey) {
				console.log("showReport = " + reportKey);
				$location.search('key', reportKey).path('/editReport');
			}
		} ]);
		myApp.controller("editReportController", [ "$rootScope", "$scope", "$http", "$location", function($rootScope, $scope, $http, $location) {
			if (!$rootScope.loginAccount) {
				$location.path('/');
				return;
			}
			var loadSuccess = function(data) {
				$scope.report = data;
			};
			var loadFail = function(e) {
				console.log("error" + e);
				$location.path('/');
			};
			if ($location.search()["key"]) {
				$http.get("api/report/load/" + $location.search()["key"], {
					params : {
						accessKey : $scope.loginAccount.accessKey,
					}
				}).success(loadSuccess).error(loadFail);
			} else {
				$http.get("api/report/create", {
					params : {
						accessKey : $scope.loginAccount.accessKey
					}
				}).success(loadSuccess).error(loadFail);
			}
			$scope.doAction = function() {
				console.log('doAction = ' + $scope.action);
				$scope.report.accountAccessKey = $rootScope.loginAccount.accessKey;
				$http.post("api/report", $scope.report).success(function(data) {
					console.log("completed" + data);
					$location.search("lastAction", "{\"action\":\"saved\",\"key\":\"" + $scope.report.key + "\"}").path('/myPage');
				}).error(function(e) {
					console.log("error" + e);
				});
			}
			$scope.changeAction = function(action) {
				$scope.action = action;
			}
			$scope.action = "save";
		} ]);
	</script>
	<div id="header" ng-include="'template/header.html'"></div>
</body>
</html>