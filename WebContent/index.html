<!DOCTYPE html>
<html ng-app="myApp">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="api/app/rootURL.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular-cookies.js"></script>

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.10.0/ui-bootstrap-tpls.min.js"></script>
<script src="//code.angularjs.org/1.2.19/angular-route.min.js"></script>

<script type="text/javascript" src="scripts/marked.min.js"></script>
<script type="text/javascript" src="scripts/angular-marked.min.js"></script>
<script type="text/javascript" src="scripts/angular-file-upload-shim.min.js"></script>
<script type="text/javascript" src="scripts/angular-file-upload.min.js"></script>
<link rel="stylesheet" href="//yandex.st/highlightjs/8.0/styles/github.min.css">
<script src="//yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script type="text/javascript" src="scripts/angular-translate.min.js"></script>
<script type="text/javascript" src="scripts/loader-static-files.js"></script>
<link rel="stylesheet" href="scripts/application.css">
</head>
<body>
	<div id="header" ng-include="'template/header.html'"></div>
	<div style="position: fixed; top: 60px; width: 100%; margin: 0; padding: 0;" ng-show="alert">
		<div class="row" style="margin: 0; padding: 0;">
			<div class="col-xs-6 col-xs-offset-3" style="padding: 0; z-index: 99;">
				<alert id="alert" ng-mouseover="cancelAlertCloseTimer()" ng-model="alert" type="alert.type" close="closeAlert()">{{alert.message}}</alert>
			</div>
		</div>
	</div>
	<div id="content" ng-view></div>
	<div id="header" ng-include="'template/footer.html'"></div>
	<script type="text/javascript">
		function findLanguage() {
			try {
				return (navigator.browserLanguage || navigator.language || navigator.userLanguage).substr(0, 2)
			} catch (e) {
				return "en";
			}
		}
		var myApp = angular.module('myApp', [ 'ui.bootstrap', 'hc.marked', 'ngRoute', 'ngCookies', 'angularFileUpload', 'pascalprecht.translate' ]);
		myApp.config([ 'markedProvider', '$routeProvider', '$locationProvider', '$translateProvider', function(markedProvider, $routeProvider, $locationProvider, $translateProvider) {
			markedProvider.setOptions({
				gfm : true,
				tables : true,
				breaks : true,
				highlight : function(code) {
					return hljs.highlightAuto(code).value;
				}
			});
			$translateProvider.useStaticFilesLoader({
				prefix : 'scripts/translate/lang_',
				suffix : '.json?' + new Date().getTime()
			});
			$translateProvider.preferredLanguage(findLanguage());
			$translateProvider.fallbackLanguage('en');
			$translateProvider.useMissingTranslationHandlerLog();

			$routeProvider.when('/', {
				templateUrl : 'template/top.html'
			}).when('/myPage', {
				templateUrl : 'template/myPage.html?' + new Date().getTime()
			}).when('/editReport', {
				templateUrl : 'template/editReport.html?' + new Date().getTime()
			}).when('/report', {
				templateUrl : 'template/report.html?' + new Date().getTime()
			}).when('/editProfile', {
				templateUrl : 'template/editProfile.html?' + new Date().getTime()
			}).when('/login', {
				templateUrl : 'template/login.html?' + new Date().getTime()
			}).when('/logout', {
				controller : "logoutController",
				templateUrl : 'template/empty.html'
			}).otherwise({
				redirectTo : '/'
			});
			$locationProvider.html5Mode(true);
		} ]);
		myApp.run([ "$rootScope", "$http", "$cookies", "$location", "$timeout", function($rootScope, $http, $cookies, $location, $timeout) {
			$rootScope.closeAlert = function() {
				$rootScope.alert = null;
			}
			$rootScope.cancelAlertCloseTimer = function() {
				if ($rootScope.timeoutHandle) {
					$timeout.cancel($rootScope.timeoutHandle);
				}
			}
			$rootScope.showAlert = function(message, type, time) {
				var useType = type ? type : 'danger';
				var useTime = time ? time : 5000;
				$rootScope.alert = {
					type : useType,
					message : message
				}
				$rootScope.timeoutHandle = $timeout(function() {
					$rootScope.closeAlert()
				}, useTime);
			}
			var accountAccessKey = $cookies.accountAccessKey;
			$rootScope.logout = function() {
				$location.path('/logout');
			}
			$rootScope.clone = function(obj) {
				if (null == obj || "object" != typeof obj)
					return obj;
				var copy = obj.constructor();
				for ( var attr in obj) {
					if (obj.hasOwnProperty(attr))
						copy[attr] = obj[attr];
				}
				return copy;
			}
			if (accountAccessKey) {
				$http.get("api/account/loadByAccessKey", {
					params : {
						accessKey : accountAccessKey
					}
				}).success(function(account) {
					$rootScope.loginAccount = account;
				}).error(function(e) {
					$rootScope.logout();
				});
			}
		} ]);
		myApp.controller("logoutController", [ "$rootScope", "$location", "$cookies", function($rootScope, $location, $cookies) {
			$rootScope.loginAccount = null;
			var past = new Date();
			past.setTime(0);
			document.cookie = "accountAccessKey=;expires=" + past.toGMTString();
			for ( var i in $location.search()) {
				$location.search(i, null)
			}
			$location.path('/');
		} ]);
		myApp.controller("loginController", [ "$rootScope", "$scope", "$http", "$location", "$cookies", "$translate", function($rootScope, $scope, $http, $location, $cookies, $translate) {
			$scope.tryLoginAccount = {};
			$scope.newAccount = {};
			if ($rootScope.loginAccount) {
				$location.path('/myPage');
				return;
			}
			var routeToAfterLogin = function() {
				if ($location.search()["afterLoginPath"]) {
					$location.path($location.search()["afterLoginPath"]);
					$location.search("afterLoginPath", null);
				} else {
					$location.path('/myPage');
				}
			}
			$scope.createAccount = function() {
				$http.post("api/account", $scope.newAccount).success(function(data) {
					$rootScope.loginAccount = data;
					routeToAfterLogin();
				}).error(function(e) {
					console.log("error" + e);
				});
			}
			$scope.login = function() {
				$http.post("api/account/login", $scope.tryLoginAccount).success(function(data) {
					$rootScope.loginAccount = data;
					var cookieExpires = new Date();
					cookieExpires.setTime(cookieExpires.getTime() + 30 * 24 * 60 * 60 * 1000);
					document.cookie = "accountAccessKey=" + $rootScope.loginAccount.accessKey + ";expires=" + cookieExpires.toGMTString() + ";";
					routeToAfterLogin();
				}).error(function(e) {
					$rootScope.showAlert($translate.instant('error.login'));
				});
			}
			$scope.action = "save";
		} ]);
		myApp.controller("myPageController", [ "$rootScope", "$scope", "$http", "$location", function($rootScope, $scope, $http, $location) {
			if (!$rootScope.loginAccount) {
				$location.path('/');
				return;
			}
			$http.get("api/report/loadByAccessKey", {
				params : {
					accessKey : $rootScope.loginAccount.accessKey
				}
			}).success(function(data) {
				$scope.reports = data;
			}).error(function(e) {
				console.log("error" + e);
			});
			$http.get("api/account/fold", {
				params : {
					accessKey : $rootScope.loginAccount.accessKey
				}
			}).success(function(data) {
				$scope.folds = data;
			}).error(function(e) {
				console.log("error" + e);
			});
			$http.get("api/news", {
				params : {
					accessKey : $rootScope.loginAccount.accessKey
				}
			}).success(function(data) {
				$scope.newses = data;
			}).error(function(e) {
				console.log("error" + e);
			});
			$scope.createReport = function() {
				for ( var i in $location.search()) {
					$location.search(i, null)
				}
				$location.path('/editReport');
			}
			$scope.editProfile = function() {
				$location.path('/editProfile');
			}
			$scope.showReport = function(reportKey) {
				$location.search('key', reportKey)
				$location.path('/editReport');
			}
			$scope.showPublishedReport = function(report, $event) {
				$location.search("key", report.key).path("/report");
				if ($event) {
					$event.stopPropagation();
				}
			}
		} ]);
		myApp.controller("reportController", [ "$rootScope", "$scope", "$http", "$location", "$modal", function($rootScope, $scope, $http, $location, $modal) {
			if (!$location.search()["key"]) {
				return;
			}
			var reportLoadAccessKey = null;
			if ($rootScope.loginAccount) {
				reportLoadAccessKey = $rootScope.loginAccount.accessKey;
			}
			$http.get("api/report/load/" + $location.search()["key"], {
				params : {
					accountAccessKey : reportLoadAccessKey
				}
			}).success(function(report) {
				$scope.report = report;
				$http.get("api/report/" + report.key + "/comment", {
					params : {
						accountAccessKey : reportLoadAccessKey
					}
				}).success(function(comments) {
					$scope.comments = comments;
				}).error(function(e) {
					console.log("error " + e)
				});
			}).error(function(e) {
				console.log("error" + e);
			});
			var switchFold = function(fold) {
				if (!$rootScope.loginAccount) {
					$location.search('afterLoginPath', $location.path())
					$location.path('/login');
					return;
				}
				if ($scope.folding) {
					return;
				}
				$scope.folding = true;
				var onSuccessFunction = function() {
					$scope.report.folded = fold;
					if (fold) {
						$scope.report.foldedCount++;
					} else {
						$scope.report.foldedCount--;
					}
					$scope.folding = false;
				}
				var onErrorFunction = function() {
					$scope.folding = false;
				}
				var params = {
					key : $scope.report.key,
					accountAccessKey : $rootScope.loginAccount.accessKey
				}
				if (fold) {
					$http.post("api/report/fold", params).success(onSuccessFunction).error(onErrorFunction);
				} else {
					$http["delete"]("api/report/fold", {
						params : params
					}).success(onSuccessFunction).error(onErrorFunction);
				}
			}
			$scope.fold = function() {
				switchFold(true);
			}
			$scope.unfold = function() {
				switchFold(false);
			}
			$scope.follow = function() {
				$http.post("api/account/follow", {
					accountAccessKey : $rootScope.loginAccount.accessKey,
					targetAccountId : $scope.report.reporter.id,
				}).success(function() {
					$scope.report.reporter.following = true;
				}).error(function(e) {
					console.log("error " + e)
				});
			}
			$scope.unfollow = function() {
				$http.put("api/account/unfollow", {
					accountAccessKey : $rootScope.loginAccount.accessKey,
					targetAccountId : $scope.report.reporter.id,
				}).success(function() {
					$scope.report.reporter.following = false;
				}).error(function(e) {
					console.log("error " + e)
				});
			}
			$scope.createAccountForComment = function() {
				$location.search('afterLoginPath', $location.path())
				$location.path('/login');
			}
			$scope.comment = function() {
				if ("" == $scope.inputMessage) {
					return;
				}
				$http.post("api/report/comment", {
					accountAccessKey : $rootScope.loginAccount.accessKey,
					reportKey : $scope.report.key,
					message : $scope.inputMessage
				}).success(function(comments) {
					$scope.inputMessage = "";
					$scope.comments = comments;
				}).error(function(e) {
					console.log(e)
				});
			}
			$scope.deleteComment = function(comment) {
				$http["delete"]("api/report/" + $scope.report.key + "/comment", {
					params : {
						accountAccessKey : $rootScope.loginAccount.accessKey,
						commentId : comment.id
					}
				}).success(function(comments) {
					$scope.comments = comments
				}).error(function(e) {
					console.log(e)
				});
			}
			$scope.updateComment = function(comment) {
				$http.put("api/report/" + $scope.report.key + "/comment", {
					accountAccessKey : $rootScope.loginAccount.accessKey,
					id : comment.id,
					message : comment.message
				}).success(function(comments) {
					$scope.comments = comments
				}).error(function(e) {
					console.log(e)
				});
			}
			$scope.openDeleteCommentDialog = function(comment) {
				var ModalInstanceCtrl = [ "$scope", "$modalInstance", "comment", function($scope, $modalInstance, comment) {
					$scope.title = "delete comment?";
					$scope.body = "Are you sure to delete comment? \n \"" + comment.message + "\"";
					$scope.execute = function() {
						$modalInstance.close(comment);
					};
				} ];
				var modalInstance = $modal.open({
					templateUrl : 'template/confirmDialog.html?' + new Date().getTime(),
					controller : ModalInstanceCtrl,
					resolve : {
						comment : function() {
							return comment;
						}
					}
				});
				modalInstance.result.then(function(comment) {
					$scope.deleteComment(comment);
				}, function() {
					console.log('Modal dismissed at: ' + new Date());
				});
			}
			$scope.openEditCommentDialog = function(comment) {
				var ModalInstanceCtrl = [ "$scope", "$modalInstance", "comment", function($scope, $modalInstance, comment) {
					$scope.comment = comment;
					$scope.execute = function(comment) {
						$modalInstance.close(comment);
					};
				} ];
				var modalInstance = $modal.open({
					templateUrl : 'template/editCommentDialog.html?' + new Date().getTime(),
					controller : ModalInstanceCtrl,
					resolve : {
						comment : function() {
							return $rootScope.clone(comment);
						}
					}
				});
				modalInstance.result.then(function(comment) {
					$scope.updateComment(comment);
				}, function() {
					console.log('Modal dismissed at: ' + new Date());
				});

			}
		} ]);
		myApp.controller("editReportController", [ "$rootScope", "$scope", "$http", "$location", "$modal", function($rootScope, $scope, $http, $location, $modal) {
			if (!$rootScope.loginAccount) {
				$location.path('/login');
				return;
			}
			$scope.escapable = false;
			var removeLocationChangeStart = $scope.$on('$locationChangeStart', function(event, next, current) {
				if (!$scope.escapable && !confirm("Are you sure you want to leave this page?")) {
					event.preventDefault();
				} else {
					removeLocationChangeStart();
				}
			});
			var loadSuccess = function(data) {
				$scope.report = data;
				if ("published" == $scope.report.status) {
					$scope.action = "publish";
				} else if ("private" == $scope.report.status) {
					$scope.action = "save as private";
				} else {
					$scope.action = "save as draft";
				}
			};
			var loadFail = function(e) {
				console.log("error" + e);
				$location.path('/');
			};
			if ($location.search()["key"]) {
				$http.get("api/report/load/" + $location.search()["key"], {
					params : {
						accountAccessKey : $scope.loginAccount.accessKey,
					}
				}).success(loadSuccess).error(loadFail);
			} else {
				$http.get("api/report/create", {
					params : {
						accessKey : $scope.loginAccount.accessKey
					}
				}).success(loadSuccess).error(loadFail);
			}
			$scope.doAction = function() {
				$scope.escapable = true;
				if ("delete" != $scope.action) {
					$scope.report.accountAccessKey = $rootScope.loginAccount.accessKey;
					$http.put("api/report", $scope.report).success(function(data) {
						$location.search("lastAction", "{\"action\":\"saved\",\"key\":\"" + $scope.report.key + "\"}").path('/myPage');
					}).error(function(e) {
						console.log("error" + e);
					});
				} else {
					var ModalInstanceCtrl = [ "$scope", "$modalInstance", "title", "body", "report", function($scope, $modalInstance, title, body, report) {
						$scope.title = title;
						$scope.body = body;
						$scope.execute = function() {
							$modalInstance.close(report.key);
						};
					} ];
					var modalInstance = $modal.open({
						templateUrl : 'template/confirmDialog.html?' + new Date().getTime(),
						controller : ModalInstanceCtrl,
						resolve : {
							title : function() {
								return "Delete Report?";
							},
							body : function() {
								return "You realy want to delete this report?";
							},
							report : function() {
								return $scope.report;
							}
						}
					});
					modalInstance.result.then(function(deleteReportKey) {
						$scope.deleteReport(deleteReportKey);
					}, function() {
						console.log('Modal dismissed at: ' + new Date());
					});
				}
			};
			$scope.changeAction = function(action) {
				if ("publish" == action) {
					$scope.report.status = "published";
				} else if ("save as draft" == action) {
					$scope.report.status = "draft";
				} else if ("save as private" == action) {
					$scope.report.status = "private";
				}
				$scope.action = action;
			};
			$scope.cancel = function() {
				$scope.escapable = true;
				for ( var i in $location.search()) {
					$location.search(i, null)
				}
				$location.path('/myPage');
			};
			$scope.deleteReport = function(reportKey) {
				$scope.escapable = true;
				$http["delete"]("api/report", {
					params : {
						key : reportKey,
						accountAccessKey : $rootScope.loginAccount.accessKey
					}
				}).success(function() {
					$location.search("lastAction", "{\"action\":\"deleted\",\"key\":\"" + $scope.report.key + "\"}").path('/myPage');
				}).error(function() {
					console.log("e");
				});
			};
		} ]);
		myApp.controller("editProfileController", [ "$rootScope", "$scope", "$http", "$location", "$upload", function($rootScope, $scope, $http, $location, $upload) {
			if (!$rootScope.loginAccount) {
				$location.path('/');
				return;
			}
			$scope.editingAccount = $rootScope.clone($rootScope.loginAccount);
			$scope.onIconImageSelect = function($file) {
				(function() {
					var value = $upload.upload({
						url : "api/account/registImage",
						method : "POST",
						data : {
							accountAccessKey : $rootScope.loginAccount.accessKey
						},
						file : $file
					}).progress(function(evt) {
						console.log('percent: ' + parseInt(100.0 * evt.loaded / evt.total));
					}).success(function(imageKey, status, headers, config) {
						$scope.editingAccount.iconUrl = "api/account/icon/" + imageKey;
					}).error(function(data, status, headers, config) {
						console.log("uploadFailed = " + data);
					});
					console.log("uploaded = " + value);
				})();
			}
			$scope.cancel = function(action) {
				$location.path('/myPage');
			}
			$scope.save = function(action) {
				var accountAccessKey = $rootScope.loginAccount.accessKey;
				$scope.editingAccount.accessKey = accountAccessKey;
				$http.put("api/account/update", $scope.editingAccount).success(function(account) {
					$rootScope.loginAccount = $rootScope.clone(account);
					$rootScope.loginAccount.accessKey = accountAccessKey;
					$location.path('/myPage');
				}).error(function(e) {
					console.log(e)
				});
			}
		} ]);
	</script>
</body>
</html>